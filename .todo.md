# Todo List - Multiple Active Tasks

## 1. Fix TUI Corruption Issue in Session Deletion (COMPLETED ✅)

### Task: Fix blocking delete_session call that corrupts TUI

**Problem**: Session deletion calls `load_real_workspaces().await` which blocks UI and causes TUI corruption.

### Analysis Phase
- [x] Write failing tests to document expected behavior
- [x] Confirm delete operation takes 605ms (6x target of <100ms)
- [x] Identify root cause: blocking `load_real_workspaces()` call on line 2695

### Implementation Phase (TDD)
- [x] **COMPLETED**: Remove blocking load_real_workspaces() call from delete_session
- [x] **COMPLETED**: Ensure proper UI state cleanup without full reload
- [x] **COMPLETED**: Verify UI refresh mechanism works correctly
- [x] **COMPLETED**: Run tests to verify fix works and performance improves

### Results
- **BEFORE**: Delete operation took 605ms (6x over target)
- **AFTER**: All tests pass with excellent performance (<100ms target achieved)
- **UI STATE**: Sessions properly removed from UI without blocking reload
- **REFRESH**: UI refresh flag properly set for non-blocking updates

---

## 2. Fix Session Name Mismatch Issue (Existing - ON HOLD)

## Analysis Phase
- [x] Examine current session name creation logic in tmux/session.rs
- [x] Examine session attachment logic in app/tmux_handler.rs
- [x] Examine session loading logic in app/session_loader.rs
- [x] Identify the exact mismatch between creation and attachment naming

## Analysis Results

**MISMATCH IDENTIFIED:**

1. **Session::new()** (models/session.rs:110): Uses `name` parameter directly
   ```rust
   let tmux_session_name = format!("ciab_{}", name.replace(' ', "_").replace('.', "_"));
   ```

2. **TmuxSession::create()** (tmux/session.rs:53): Also uses `name` parameter directly
   ```rust
   let session_name = format!("ciab_{}", name.replace(' ', "_").replace('.', "_"));
   ```

3. **SessionLoader::create_session_from_worktree()** (session_loader.rs:156): Uses `branch_name`
   ```rust
   session.tmux_session_name = format!("ciab_{}", worktree_info.branch_name.replace(' ', "_").replace('.', "_"));
   ```

4. **SessionManager::create_session()** (session/manager.rs:89): Uses actual tmux session name
   ```rust
   tmux_session_name: tmux_session.name.clone(),
   ```

**THE ISSUE:** Different parts use different inputs (`name` vs `branch_name` vs actual tmux name), and TmuxSession may add timestamps (like "ciab_claude-in-a-box_20250923_220041") while Session model doesn't expect them.

## Implementation Phase
- [x] Confirm session name mismatch through failing test
- [x] Fix session name consistency between creation and attachment
- [x] Ensure tmux_session_name stored in Session model matches actual tmux session name (DONE: All use centralized sanitization)
- [x] Update attachment logic to use exact tmux_session_name from Session model (Already working correctly)
- [x] Fix any parsing issues in SessionLoader creating wrong session names (DONE: SessionLoader uses same sanitization)

## Testing Phase
- [x] Write test to verify session creation and attachment with consistent names
- [x] Test creating a session and attaching without "can't find session" errors
- [x] Verify tmux session names match what's stored in the Session model

## Previous Work (Context)
### ✅ COMPLETED
- [x] SessionManager integration into AppState
- [x] Basic tmux session creation and attachment infrastructure
- [x] PTY I/O forwarding in tmux/session.rs

## Implementation Notes
- Follow TDD: Red-Green-Refactor cycle
- Test behavior, not implementation
- Focus on end-to-end functionality
- Sessions should actually create and show up in UI
- Interactive attachment should work properly

---

## 2. Verify Worktree Session Creation (NEW - CURRENT TASK)

### Task: Verify that claude-in-a-box ONLY creates sessions in worktree directory

**Problem**: Need to ensure sessions are ALWAYS created in ~/.claude-in-a-box/worktrees/by-name/ and never in /tmp or other locations.

### Requirements
1. Check WorktreeManager.generate_worktree_path() always uses worktree base directory
2. Verify session manager uses WorktreeManager properly
3. Check app state session creation paths
4. Ensure no code paths create sessions in /tmp
5. Verify interactive and boss mode use same worktree creation logic
6. Fix any issues to ensure consistent worktree-only behavior

### Analysis Phase
- [x] **ANALYZE** - Check WorktreeManager.generate_worktree_path() implementation
- [x] **ANALYZE** - Check session manager uses WorktreeManager properly
- [x] **ANALYZE** - Check app state session creation paths
- [x] **ANALYZE** - Verify no /tmp or other location usage
- [x] **ANALYZE** - Ensure interactive and boss mode consistency

### Implementation Phase
- [x] **FIX** - Remove /tmp usage in session_loader.rs for orphaned sessions
- [x] **VERIFY** - Run tests to confirm all worktree paths use by-name structure

### Results
✅ **VERIFIED**: All sessions are created in ~/.claude-in-a-box/worktrees/by-name/
✅ **FIXED**: No sessions created in /tmp (orphaned sessions now use home directory)
✅ **CONSISTENT**: Both interactive and boss mode use identical worktree creation logic

### Expected Outcome
- All sessions created in: ~/.claude-in-a-box/worktrees/by-name/{repo}--{branch}--{uuid}/
- No sessions in /tmp or elsewhere
- Consistent behavior across all session creation modes